# タスク：LSP-MCP実装計画

## 実装計画

### フェーズ1: プロジェクトセットアップとMCPサーバー基盤 (推定期間: 3日)

- タスク1.1: プロジェクト初期化とパッケージ設定 | Node.jsプロジェクト初期化、TypeScript設定、依存関係インストール (依存: なし | 工数: 2h | ステータス: DONE)
- タスク1.2: MCP SDKの統合とサーバー骨格作成 | @modelcontextprotocol/sdk導入、MCPサーバー基本構造実装 (依存: 1.1 | 工数: 4h | ステータス: DONE)
- タスク1.3: 設定ファイル管理システムの実装 | .lsp-mcp.json読み込み、バリデーション、デフォルト値提供 (依存: 1.1 | 工数: 3h | ステータス: DONE)
- タスク1.4: ファイルシステムスキャナーの実装 | プロジェクトディレクトリスキャン、対象ファイル列挙機能 (依存: 1.3 | 工数: 4h | ステータス: DONE)

### フェーズ2: AST解析とドキュメント解析 (推定期間: 5日)

- タスク2.1: Tree-sitterのセットアップと言語パーサー統合 | Tree-sitter本体と各言語パーサー（TS/JS, Python, Go, Rust, Java, C/C++/Arduino）のインストール・設定 (依存: 1.1 | 工数: 4h | ステータス: DONE)
- タスク2.2: AST解析エンジンの実装 | Tree-sitter使用によるソースコードからASTへの変換機能 (依存: 2.1 | 工数: 5h | ステータス: DONE)
- タスク2.3: シンボル抽出機能の実装（関数、クラス、変数） | ASTから関数、クラス、変数定義を抽出 (依存: 2.2 | 工数: 8h | ステータス: DONE)
- タスク2.4: コメント・docstring抽出機能の実装 | ソースコードからコメント、docstring、TODO/FIXMEマーカーを抽出 (依存: 2.3 | 工数: 4h | ステータス: DONE)
- タスク2.5: Markdownパーサーの実装 | Markdownファイルの構造解析と情報抽出（見出し、コードブロック、リンク） (依存: 1.1 | 工数: 4h | ステータス: DONE)
- タスク2.6: ドキュメント-コード関連付け機能の実装 | ドキュメント内のコード参照と実際のソースコードを紐付け (依存: 2.3, 2.5 | 工数: 6h | ステータス: DONE)

### フェーズ3: ベクターDB統合と検索機能 (推定期間: 5日)

> **設計変更（2025-01-03）**: ベクターDBサポートをMilvus standaloneとZilliz Cloudのみに変更（Chromaプラグイン削除）

- タスク3.1: ベクターDBプラグインインターフェースの設計 | 複数のベクターDBに対応するための共通インターフェース定義 (依存: 1.1 | 工数: 3h | ステータス: DONE)
- タスク3.2: Milvusプラグインの実装（ローカルDocker + クラウド対応） | Milvus standalone接続、Zilliz Cloud接続、コレクション管理、ベクトル操作、類似検索 (依存: 3.1 | 工数: 9h | ステータス: DONE)
- タスク3.3: Chromaプラグインの実装（軽量代替DB） | DEPRECATED - 設計変更により廃止 (依存: 3.1 | 工数: 5h | ステータス: DEPRECATED)
- タスク3.4: ローカル埋め込みエンジンの実装（Transformers.js） | ローカル実行可能な埋め込みモデル実装（all-MiniLM-L6-v2、外部通信なし） (依存: 1.3 | 工数: 6h | ステータス: DONE)
- タスク3.5: クラウド埋め込みエンジンの実装（OpenAI, VoyageAI） | クラウドベースの埋め込みAPI対応、レート制限、リトライ機能 (依存: 1.3 | 工数: 5h | ステータス: DONE)
- タスク3.6: モード切り替え機能の実装 | ローカルモードとクラウドモードの切り替え、外部通信ブロック、モード選択ウィザード (依存: 3.4, 3.5 | 工数: 4h | ステータス: DONE)
- タスク3.7: BM25全文検索エンジンの実装 | ローカル全文検索（転置インデックス、BM25スコアリング、SQLite保存） (依存: 1.1 | 工数: 6h | ステータス: DONE)
- タスク3.8: ハイブリッド検索エンジンの実装 | BM25とベクトル検索を組み合わせた検索、スコア正規化、重み付けパラメータ設定 (依存: 3.7, 3.2 | 工数: 6h | ステータス: DONE)
- タスク3.9: コードクリーンアップ（Chroma・docker-manager削除） | 設計変更に伴う不要なコード削除、依存関係削除 (依存: 3.2, 3.3 | 工数: 2h | ステータス: DONE)

### フェーズ4: Indexing ServiceとMCPツール実装 (推定期間: 4日)

- タスク4.1: Indexing Serviceの実装 | インデックス化処理全体を管理、進捗追跡、エラー収集、並列処理 (依存: 2.6, 3.4 | 工数: 7h | ステータス: DONE)
- タスク4.2: MCPツール: index_projectの実装 | プロジェクトインデックス化のMCPツール、パラメータバリデーション、進捗ストリーミング応答 (依存: 4.1, 1.2 | 工数: 4h | ステータス: DONE)
- タスク4.3: MCPツール: search_codeの実装 | セマンティックコード検索のMCPツール、ハイブリッド検索連携、結果フォーマット (依存: 3.6, 1.2 | 工数: 3h | ステータス: DONE)
- タスク4.4: MCPツール: get_symbolの実装 | シンボル検索のMCPツール、定義・参照検索、スコープ別区別 (依存: 4.1, 1.2 | 工数: 4h | ステータス: DONE)
- タスク4.5: MCPツール: find_related_docsの実装 | 関連ドキュメント検索のMCPツール、関連度スコアソート (依存: 2.6, 1.2 | 工数: 3h | ステータス: DONE)
- タスク4.6: MCPツール: get_index_status, clear_indexの実装 | インデックス管理のMCPツール、メタデータ管理 (依存: 4.1, 1.2 | 工数: 2h | ステータス: DONE)

### フェーズ5: インクリメンタル更新とファイル監視 (推定期間: 3日)

- タスク5.1: File Watcherの実装 | ファイルシステム変更監視（chokidar）、デバウンス処理500ms (依存: 1.3 | 工数: 4h | ステータス: DONE)
- タスク5.2: インクリメンタル更新機能の実装 | 変更ファイルのみ再インデックス化、差分更新、エラーハンドリング (依存: 5.1, 4.1 | 工数: 5h | ステータス: DONE)
- タスク5.3: バックグラウンド更新タスクの実装 | インクリメンタル更新の非同期実行、ワーカースレッド、優先度制御、CPU使用率制限 (依存: 5.2 | 工数: 4h | ステータス: DONE)

### フェーズ6: テストとドキュメント化 (推定期間: 3日)

- タスク6.1: ユニットテストの拡充 | ユニットテストカバレッジ向上（目標80%以上）、200+テストケース追加 (依存: Phase 1-5 | 工数: 8h | ステータス: DONE)
- タスク6.2: 統合テストの作成 | E2Eテスト・シナリオベーステスト、サンプルプロジェクト、22テスト成功 (依存: Phase 1-5 | 工数: 6h | ステータス: DONE)
- タスク6.3: パフォーマンステストの実施 | 性能要件検証（10,000ファイル、検索レスポンス、メモリ使用量）、ボトルネック分析 (依存: 6.2 | 工数: 4h | ステータス: DONE)
- タスク6.4: ユーザードキュメントの作成 | README、SETUP、CONFIGURATION、TROUBLESHOOTINGガイド作成 (依存: Phase 1-5 | 工数: 5h | ステータス: DONE)
- タスク6.5: API/開発者ドキュメントの作成 | アーキテクチャ図、PLUGIN_DEVELOPMENT、MCP_TOOLS_APIドキュメント作成 (依存: 6.4 | 工数: 4h | ステータス: DONE)

### フェーズ7: 最適化とリリース準備 (推定期間: 2日)

- タスク7.1: パフォーマンス最適化 | ParserPool、QueryCache、CachedEmbeddingEngine実装、期待改善率: インデックス化30-50%短縮、検索50-75%短縮 (依存: 6.3 | 工数: 6h | ステータス: DONE)
- タスク7.2: エラーハンドリングとロギングの改善 | エラーメッセージ改善、suggestionフィールド追加、ログローテーション実装 (依存: Phase 1-6 | 工数: 3h | ステータス: DONE)
- タスク7.3: セキュリティレビュー | センシティブファイル除外、APIキー安全保存、TLS/SSL暗号化、npm audit実行 (依存: Phase 1-6 | 工数: 3h | ステータス: DONE)
- タスク7.4: Claude Codeとの統合テスト | 実際のClaude Code環境での動作確認、統合ガイド作成 (依存: Phase 1-6 | 工数: 4h | ステータス: DONE)
- タスク7.5: リリース準備 | npmパッケージ公開準備、LICENSE、CHANGELOG作成、Semantic Versioning戦略決定 (依存: 7.4 | 工数: 2h | ステータス: DONE)

### フェーズ8: ゼロコンフィグ対応とドキュメント整備 (推定期間: 2日)

- タスク8.1: docs/requirements.mdへのゼロコンフィグ要件追加 | ストーリー7、受入基準REQ-030〜034、非機能要件NFR-029〜031追加 (依存: なし | 工数: 1h | ステータス: DONE)
- タスク8.2: docs/design.mdへの環境変数ベース設定設計追加 | コンポーネント9、技術的決定事項6追加、設定優先順位明記 (依存: 8.1 | 工数: 1.5h | ステータス: DONE)
- タスク8.3: docs/tasks.mdへのフェーズ8追加 | 本フェーズのタスク定義追加、タスク8.1〜8.6定義 (依存: 8.2 | 工数: 0.5h | ステータス: DONE)
- タスク8.4: README.mdのクイックスタート書き換え | ゼロコンフィグ手順を最上位に配置、設定ファイル作成を任意化 (依存: 8.3 | 工数: 2h | ステータス: TODO)
- タスク8.5: docs/ENVIRONMENT_VARIABLES.md作成 | 環境変数の完全なリファレンスドキュメント、設定優先順位、ユースケース別設定例 (依存: 8.3 | 工数: 2h | ステータス: TODO)
- タスク8.6: docs/SETUP.mdへの環境変数セクション追加 | ゼロコンフィグモードセクション追加、環境変数ベースセットアップ手順、従来方式との比較表 (依存: 8.5 | 工数: 1.5h | ステータス: TODO)

### フェーズ9: OpenTelemetry監視機能実装 (推定期間: 3日)

- タスク9.1: OpenTelemetry依存関係のインストール | @opentelemetry/sdk-node、@opentelemetry/api、@opentelemetry/exporter-trace-otlp-grpc、@opentelemetry/exporter-metrics-otlp-grpc、@opentelemetry/exporter-logs-otlp-httpのインストール (依存: なし | 工数: 0.5h | ステータス: TODO)
- タスク9.2: TelemetryManagerクラスの実装 | OpenTelemetry SDK初期化、環境変数・設定ファイルからの設定読み込み、条件付き有効化（デフォルトオフ） (依存: 9.1 | 工数: 4h | ステータス: TODO)
- タスク9.3: トレースインストルメンテーションの実装 | MCPツール呼び出しトレース（tool.name, tool.params, tool.duration）、ベクターDB操作トレース（operation.type, operation.duration）、AST解析トレース、埋め込み生成トレース (依存: 9.2 | 工数: 6h | ステータス: TODO)
- タスク9.4: メトリクス収集の実装 | Counter（requests.total, requests.errors, vectordb.operations）、Histogram（requests.duration, search.results）、Gauge（index.files, index.symbols, memory.usage）の実装 (依存: 9.2 | 工数: 5h | ステータス: TODO)
- タスク9.5: ログエクスポーターの実装 | エラーログ（error level）、警告ログ（warn level）、情報ログ（info level）、デバッグログ（debug level）のOTLP経由エクスポート (依存: 9.2 | 工数: 3h | ステータス: TODO)
- タスク9.6: 分散トレーシングのコンテキスト伝播実装 | ベクターDB、埋め込みAPI等の外部サービス呼び出し時のトレースコンテキスト伝播、W3C Trace Context準拠 (依存: 9.3 | 工数: 3h | ステータス: TODO)
- タスク9.7: パフォーマンス最適化 | 非同期エクスポート、バッチ処理、サンプリング（デフォルト10%）、条件付き計測（テレメトリ無効時のオーバーヘッドゼロ化） (依存: 9.3, 9.4, 9.5 | 工数: 4h | ステータス: TODO)
- タスク9.8: ヘルスチェックエンドポイントの実装 | /healthエンドポイント提供、サービス稼働状態返却、依存サービス（ベクターDB、埋め込みエンジン）の死活監視 (依存: 9.2 | 工数: 2h | ステータス: TODO)
- タスク9.9: テレメトリ機能のテスト | ユニットテスト（トレース/メトリクス/ログ収集）、統合テスト（Jaeger/Prometheus連携）、パフォーマンステスト（オーバーヘッド5%以内検証） (依存: 9.3, 9.4, 9.5, 9.6, 9.7, 9.8 | 工数: 5h | ステータス: TODO)
- タスク9.10: テレメトリドキュメントの作成 | docs/OBSERVABILITY.md作成（監視設定ガイド、環境変数リファレンス、Jaeger/Grafana/Prometheus連携手順、メトリクス一覧、トラブルシューティング） (依存: 9.9 | 工数: 3h | ステータス: TODO)

## タスクステータスの凡例
- `TODO` - 未着手
- `IN_PROGRESS` - 作業中
- `BLOCKED` - 依存関係や問題によりブロック中
- `REVIEW` - レビュー待ち
- `DONE` - 完了

## マイルストーン

| マイルストーン | 完了条件 | 目標日 |
|--------------|---------|-------|
| M1: 基盤完成 | フェーズ1完了 | 開始+3日 |
| M2: 解析機能完成 | フェーズ2完了 | 開始+8日 |
| M3: 検索機能完成 | フェーズ3完了 | 開始+13日 |
| M4: MCP統合完成 | フェーズ4完了 | 開始+17日 |
| M5: 自動更新完成 | フェーズ5完了 | 開始+20日 |
| M6: 品質保証完成 | フェーズ6完了 | 開始+23日 |
| M7: リリース準備完了 | フェーズ7完了 | 開始+25日 |
| M8: ゼロコンフィグ対応完了 | フェーズ8完了 | 開始+27日 |
| M9: 監視機能完成 | フェーズ9完了 | 開始+30日 |

## リスクと軽減策

### リスク1: Tree-sitter各言語パーサーの品質・完成度のばらつき
**影響度**: 中 | **発生確率**: 高
**軽減策**: 優先度高の5言語を先行実装、パースエラーでもスキップして処理継続、コミュニティ評価高のパーサー優先採用

### リスク2: ベクターDB接続の信頼性問題
**影響度**: 高 | **発生確率**: 中
**軽減策**: ローカルキャッシュへのフォールバック、自動リトライ機能、複数のベクターDBバックエンドサポート

### リスク3: 大規模プロジェクトでのメモリ不足
**影響度**: 高 | **発生確率**: 中
**軽減策**: ストリーミング処理、バッチサイズ調整、メモリ使用量モニタリング、ワーカースレッド分散処理

### リスク4: 埋め込みAPIのコスト
**影響度**: 中 | **発生確率**: 高
**軽減策**: ローカル埋め込みモデルオプション、インクリメンタル更新、キャッシュ機能、コスト見積もり機能

### リスク5: Claude Codeのアップデートによる互換性問題
**影響度**: 中 | **発生確率**: 中
**軽減策**: MCP公式仕様への厳密準拠、バージョン互換性テスト自動化、リリースノート追跡、後方互換性維持

## 進捗管理

### 週次レビュー項目
- [ ] 各フェーズの進捗状況確認
- [ ] ブロッカーの特定と解決策検討
- [ ] 見積もりと実績の差異分析
- [ ] 次週の優先タスク決定

### 品質ゲート
各フェーズ完了時に以下を確認：
- [ ] ユニットテストが通る
- [ ] コードレビューが完了している
- [ ] ドキュメントが更新されている
- [ ] 受入基準がすべて満たされている

## 備考

### 技術スタック概要
- **言語**: TypeScript | **ランタイム**: Node.js 18+
- **AST解析**: Tree-sitter
- **ベクターDB（ローカル）**: Milvus standalone（Docker Compose、localhost:19530）
- **ベクターDB（クラウド）**: Zilliz Cloud
- **埋め込み（デフォルト）**: Transformers.js（ローカル実行）
- **埋め込み（クラウド）**: OpenAI API、VoyageAI API（オプション）
- **全文検索**: BM25（自前実装、SQLite）
- **ファイル監視**: chokidar | **テスト**: Jest | **ビルド**: tsc

> **設計変更（2025-01-03）**: ベクターDBサポートをMilvusのみに変更（Chroma、DuckDBを削除）。VectorStorePluginインターフェースは将来の拡張性のために保持。

### 開発環境要件
- Node.js 18.0以上 | npm 9.0以上 | Docker & Docker Compose（Milvus実行用） | Git | 最低8GB RAM推奨
